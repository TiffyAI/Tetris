<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TiffyAI Tetrus</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <!-- Web3 & Web3Modal CDN -->
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
  <style>
    /* ... (your neon, metallic styles go here) ... */
  </style>
</head>
<body>
  <h1>TiffyAI Tetrus</h1>
  <canvas id="tetris" width="300" height="600"></canvas>
  <div id="score">üí∞ TIFFY: 0.00000000</div>
  <div class="action-buttons">
    <button id="restartBtn">RESTART</button>
    <button id="withdrawBtn">WITHDRAW</button>
  </div>
  <div id="touch-controls">
    <button class="control-btn" onclick="handleTouch('left')">‚¨ÖÔ∏è</button>
    <button class="control-btn" onclick="handleTouch('rotate')">üîÑ</button>
    <button class="control-btn" onclick="handleTouch('right')">‚û°Ô∏è</button>
  </div>
  <img id="bonus-animation" src="TiffyAI-Token.png" width="120" />
  <!-- Sounds -->
  <audio id="rowSound" src="row.wav"></audio>
  <audio id="overSound" src="over.wav"></audio>
  <audio id="clickSound" src="click.wav"></audio>
  <audio id="withdrawSound" src="withdraw.wav"></audio>

  <script>
    // --- Tetris Game Logic (unchanged from your validated version) ---
    // [Insert all game functions: drawMatrix, playerDrop, sweepRows, etc.]

    // --- Withdraw & Wallet Integration ---
    const withdrawSound = document.getElementById("withdrawSound");
    withdrawBtn.addEventListener("click", () => {
      withdrawSound.play();
      withdrawSound.onended = async () => {
        const cAddr = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
        const ABI = [
          {inputs:[], name:"claim", type:"function", stateMutability:"payable"},
          {inputs:[], name:"FIXED_BNB_FEE", outputs:[{internalType:"uint256",type:"uint256"}], stateMutability:"view", type:"function"}
        ];
        const BACKEND = "https://tiffyai-wh-wa.onrender.com/reward";

        const wModal = new Web3Modal.default({ cacheProvider: false, providerOptions: {
          walletconnect: {
            package: window.WalletConnectProvider?.default || {},
            options: { rpc: { 56: "https://bsc-dataseed.binance.org/" } }
          }
        }});
        const provider = await wModal.connect();
        const web3 = new Web3(provider);
        const chainId = await web3.eth.getChainId();
        if (chainId !== 56) {
          try {
            await provider.request({ method:"wallet_switchEthereumChain", params:[{chainId:"0x38"}] });
          } catch {
            return alert("Please switch to BNB Smart Chain.");
          }
        }

        const accounts = await web3.eth.getAccounts();
        const account = accounts[0];
        const contract = new web3.eth.Contract(ABI, cAddr);
        const fee = await contract.methods.FIXED_BNB_FEE().call();

        const key = `tiffyClaimed_${account}`;
        let cnt = parseInt(localStorage.getItem(key) || "0");
        if (cnt <= 0) return alert("‚ùó No TIFFY to withdraw.");

        try {
          await contract.methods.claim().send({ from: account, value: fee });
          const backendAmt = cnt - 1;
          if (backendAmt > 0) {
            await fetch(BACKEND, {
              method: "POST",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify({ wallet: account, amount: backendAmt })
            });
          }
          localStorage.setItem(key, "0");
          alert("‚úÖ Withdrawal Complete!");
        } catch (e) {
          console.error(e);
          alert("‚ùå Withdraw failed: " + (e.message || e));
        }
      };
    });
    
    // --- Game Initialization & Remaining Logic ---
    restartBtn.addEventListener("click", () => {
      clickSound.play();
      // reset board logic...
    });

    updateScore();
    resetPiece();
    update();
  </script>
</body>
</html>
