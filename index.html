<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TiffyAI Game</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>

  <!-- Game UI untouched from your original version -->
  <div id="game">
    <!-- Your game HTML and canvas, all here -->
    <canvas id="slotCanvas"></canvas>
    
    <!-- Withdraw Button -->
    <button id="withdrawButton">WITHDRAW</button>
  </div>

  <!-- Audio -->
  <audio id="withdrawSound" src="withdraw.wav" preload="auto"></audio>

  <!-- Game Script -->
  <script src="game.js"></script>

  <!-- Wallet Logic -->
  <script>
    const withdrawBtn = document.getElementById('withdrawButton');
    const withdrawSound = document.getElementById('withdrawSound');

    const contractAddress = "0xA087A88882c7011EcC5FBC325F83db6f74427284";
    const ABI = [ { "inputs": [], "name": "claim", "outputs": [], "stateMutability": "nonpayable", "type": "function" } ];

    async function connectWalletAndWithdraw() {
      try {
        const provider = window.ethereum;
        if (!provider) {
          alert("ðŸ¦Š MetaMask not found. Please install it to continue.");
          return;
        }

        await provider.request({ method: "eth_requestAccounts" });
        const web3 = new Web3(provider);
        const accounts = await web3.eth.getAccounts();
        const userAddress = accounts[0];

        // Switch to BNB Smart Chain
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x38' }],
        });

        // Check if already claimed
        const claimed = localStorage.getItem('tiffyClaimed_' + userAddress);
        if (claimed === 'true') {
          alert("â›” You've already claimed your balance.");
          return;
        }

        // Check balance
        let balance = parseFloat(localStorage.getItem('tiffyBalance') || '0');
        if (balance <= 0) {
          alert("ðŸ˜¢ No balance available to withdraw.");
          return;
        }

        alert("âœ… Connected! Processing your withdraw...");

        const contract = new web3.eth.Contract(ABI, contractAddress);
        await contract.methods.claim().send({ from: userAddress });

        // Log to backend (optional)
        await fetch('https://yourbackend.com/log-claim', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: userAddress, amount: balance }),
        });

        localStorage.setItem('tiffyClaimed_' + userAddress, 'true');
        localStorage.setItem('tiffyBalance', '0');

        alert("ðŸŽ‰ Withdraw successful! TiffyAI tokens claimed.");
      } catch (error) {
        console.error(error);
        alert("âŒ Error processing withdraw: " + error.message);
      }
    }

    withdrawBtn.addEventListener('click', () => {
      withdrawSound.play();
      withdrawSound.onended = connectWalletAndWithdraw;
    });
  </script>

</body>
</html>
